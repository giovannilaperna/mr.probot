"use strict";

var express = require('express');
var app = express();

var request = require('request');
var _ = require('underscore');
var consolidate = require('consolidate');

app.engine('html', consolidate.handlebars);
app.set('view engine', 'html');
app.set('views', __dirname + '/views');

var bycountry  = function (req, res, next) {
  res.locals = {
    total: res.locals.count_total,
    count: res.locals.results.length,
    results: _.groupBy(_.sortBy(res.locals.results, function(item) {
      return item['exchange_price']
    }), function(group) {
      return group.pricing.country
    })
  }
  next();
}

var fast  = function (req, res, next) {
  var i;
  for (i = res.locals.results.length - 1; i >= 0; i -= 1) {
    for (let item of res.locals.results[i].items) {
      if ( item['in_stock'] != true || item['offered_by_amazon'] != true) {
        res.locals.results.splice( i , 1 )
        break;
      }
    }
  }
  res.locals.count = res.locals.results.length,
  next();
}

var all  = function (req, res, next) {

  var base = 'https://api.purse.io/api/v1/';
  var usr = 'altrochepallet@gmail.com';
  var psw = 'THAVlb*maXGLpRz64fdwsy*cH';

  var i;

  if (req.query.country !== undefined) { var country = req.query.country } else { country = '' };
  if (req.query.limit !== undefined) { var limit = req.query.limit } else { limit = 50 };
  if (req.query.offset !== undefined) { var offset = req.query.offset } else { offset = 0 };
  if (req.query.amount !== undefined) { var amount = req.query.amount } else { amount = '' };
  if (req.query.hide !== undefined) { var hide = req.query.hide } else { hide = '' };

  var callbackCurated = function ( error, resp, body ) {
    for (i = body.results.length - 1; i >= 0; i -= 1) {
      delete body.results[i]['user_role'];
      delete body.results[i]['spender']['stats']['reviews'];
      // delete body.results[i]['buyer_requirements'];
      delete body.results[i]['state'];
      delete body.results[i]['service'];
      delete body.results[i]['creted_at'];
      // delete body.results[i]['available_actions'];
      delete body.results[i]['unread_messages'];
      body.results[i].pricing.current_exchange = body.results[i].pricing.buyer_pays_fiat / body.results[i].pricing.buyer_gets_btc;
      body.results[i].pricing.fee = ((body.results[i].pricing.current_exchange / body.results[i].pricing.market_exchange_rate.rate) - 1) * 100;
      if (body.results[i].pricing.market_exchange_rate.fixed == true) {body.results[i].pricing.mode = 'fixed'} else {body.results[i].pricing.mode = 'floating'};
      body.results[i].pricing.reference_rate = body.results[i].pricing.market_exchange_rate.rate;
      delete body.results[i]['pricing']['market_exchange_rate'];
    };
    res.locals = {
      total: body.count,
      count: body.results.length,
      results: _.sortBy(body.results, function(item) {
        return item['fee']
      })
    };
    next();
  }

  var callbackResults = function ( error, resp, body) {
    request({
      json: true,
      method: 'GET',
      url: base + 'orders/open?limit=' + limit + '&offset=' + offset + '&country=' + country + '&amount=' + amount + '&hide=' + hide,
      headers: {authorization: 'JWT ' + body.token}
    }, callbackCurated );
  }

  request({
    json: true,
    method: 'POST',
    url: base + 'auth',
    body: {
      "username": usr,
      "password": psw,
      "noToken": true
    }
  }, callbackResults );

}

app.get('/api/all', all, function (req, res) {
    res.json(res.locals)
  });

app.get('/api/all/bycountry', all, bycountry, function (req, res) {
  res.json(res.locals)
});

app.get('/api/fast', all, fast, function (req, res) {
    res.json(res.locals)
  });

app.get('/api/fast/bycountry', all, fast, bycountry, function (req, res) {
    res.json(res.locals)
  });

app.listen(3000, function () {
  console.log('Listening on port 3000');
});
